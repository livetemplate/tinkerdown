---
title: "Incident: API Service Unhealthy"
type: runbook-instance
template: service-unhealthy.md
template_version: 1.0
incident_id: INC-2024-0115
severity: SEV2
started: 2024-01-15T14:32:00Z
resolved: 2024-01-15T15:05:00Z
duration: 33m
on_call: alice
participants:
  - alice
  - bob
status: resolved
root_cause: Memory leak in API service caused OOM, container restarted but took 2 minutes to become healthy
sources:
  execution_log:
    type: markdown
    anchor: "#execution-log"
    readonly: false
  action_items:
    type: markdown
    anchor: "#action-items"
    readonly: false
---

# Incident: API Service Unhealthy

| Field | Value |
|-------|-------|
| **ID** | INC-2024-0115 |
| **Severity** | SEV2 |
| **Started** | 2024-01-15 14:32 UTC |
| **Resolved** | 2024-01-15 15:05 UTC |
| **Duration** | 33 minutes |
| **On-call** | Alice |
| **Participants** | Alice, Bob |

---

## Execution Log {#execution-log}

| time | step | action | result | who |
|------|------|--------|--------|-----|
| 14:32 | - | Alert received | SEV2: API health check failing | alice | <!-- id:log_001 -->
| 14:34 | 1 | Checked container status | api-service showing "unhealthy" | alice | <!-- id:log_002 -->
| 14:35 | 2 | Checked disk usage | 45% used - not the issue | alice | <!-- id:log_003 -->
| 14:36 | 2 | Checked memory | Only 200MB available! | alice | <!-- id:log_004 -->
| 14:38 | 3 | Reviewed logs | OOMKilled errors in logs | alice | <!-- id:log_005 -->
| 14:40 | - | Bob paged | Need help with memory analysis | alice | <!-- id:log_006 -->
| 14:45 | 4 | Restarted api-service | Container restarting | bob | <!-- id:log_007 -->
| 14:47 | 5 | Checked health | Still unhealthy, startup slow | bob | <!-- id:log_008 -->
| 14:50 | 5 | Checked health again | Healthy! | bob | <!-- id:log_009 -->
| 14:55 | - | Monitoring | Watching for recurrence | alice | <!-- id:log_010 -->
| 15:05 | - | Resolved | 15 min stable, closing incident | alice | <!-- id:log_011 -->

```lvt
<table lvt-source="execution_log" lvt-columns="time:Time,step:Step,action:Action,result:Result,who:Who">
</table>
```

---

## Step 1: Identify the Service

**Status:** ✅ Completed at 14:34

Identified: `api-service` container showing unhealthy status.

### Snapshot at 14:34

```
CONTAINER    STATUS                     PORTS
api-service  Up 2 hours (unhealthy)     0.0.0.0:8080->8080/tcp
postgres     Up 3 days (healthy)        5432/tcp
redis        Up 3 days (healthy)        6379/tcp
```

---

## Step 2: Check Resource Usage

**Status:** ✅ Completed at 14:36

### Disk - Snapshot at 14:35

```
Filesystem  Used   Available  Usage
/dev/sda1   45G    55G        45%
```

✅ Disk OK

### Memory - Snapshot at 14:36

```
Total   Used    Available
16G     15.8G   200M
```

⚠️ **CRITICAL: Only 200MB available!**

---

## Step 3: Check Logs

**Status:** ✅ Completed at 14:38

### Snapshot at 14:38

```
2024-01-15T14:28:03Z api-service: Processing request /api/users
2024-01-15T14:28:15Z api-service: Memory usage: 1.8GB
2024-01-15T14:29:01Z api-service: Memory usage: 2.1GB
2024-01-15T14:30:22Z api-service: Memory usage: 2.4GB
2024-01-15T14:31:45Z api-service: OOMKilled
2024-01-15T14:32:00Z api-service: Container restarting...
2024-01-15T14:32:01Z api-service: Health check failed: connection refused
```

**Finding:** Memory leak causing OOM. Container auto-restarted but health check failing during slow startup.

---

## Step 4: Restart Service

**Status:** ✅ Completed at 14:45

Bob ran:
```bash
docker restart api-service
```

Container restarted successfully.

---

## Step 5: Verify Recovery

**Status:** ✅ Completed at 14:50

### First check at 14:47
```bash
$ curl -f http://localhost:8080/health
curl: (7) Failed to connect to localhost port 8080: Connection refused
```

Still starting up.

### Second check at 14:50
```bash
$ curl -f http://localhost:8080/health
{"status":"healthy","version":"2.3.1"}
```

✅ Service healthy!

---

## Resolution Summary

**Resolved at:** 2024-01-15 15:05 UTC

**Root Cause:**
Memory leak in api-service caused OOM kill. Container was auto-restarted by Docker but health checks were failing during the slow startup (~2 minutes). Restart resolved immediate issue.

**Impact:**
- API unavailable for ~20 minutes
- ~50 failed requests during outage (from logs)
- No data loss

**What Worked:**
- Runbook steps were clear
- Memory check identified issue quickly
- Restart resolved immediate problem

**What Could Be Better:**
- Health check timeout too aggressive (fails during normal startup)
- No alerting on memory pressure before OOM
- Slow startup time should be investigated

---

## Action Items {#action-items}

| priority | owner | action | due | status |
|----------|-------|--------|-----|--------|
| P1 | alice | Investigate memory leak in /api/users endpoint | 2024-01-22 | open | <!-- id:action_001 -->
| P2 | bob | Increase health check timeout to 120s | 2024-01-17 | open | <!-- id:action_002 -->
| P2 | alice | Add memory usage alerting at 80% threshold | 2024-01-19 | open | <!-- id:action_003 -->
| P3 | bob | Profile startup time, reduce if possible | 2024-01-31 | open | <!-- id:action_004 -->

```lvt
<table lvt-source="action_items" lvt-columns="priority:Priority,owner:Owner,action:Action,due:Due,status:Status">
</table>
```

---

## Related

- **Template:** [service-unhealthy.md](../templates/service-unhealthy.md)
- **Similar incidents:** None yet
- **Follow-up:** Memory leak fix in PR #234
