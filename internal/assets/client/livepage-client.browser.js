"use strict";var LivepageClient=(()=>{var R=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var q=(n,e)=>{for(var t in e)R(n,t,{get:e[t],enumerable:!0})},j=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of O(e))!z.call(n,o)&&o!==t&&R(n,o,{get:()=>e[o],enumerable:!(r=$(e,o))||r.enumerable});return n};var W=n=>j(R({},"__esModule",{value:!0}),n);var K={};q(K,{BaseBlock:()=>c,InteractiveBlock:()=>m,LivepageClient:()=>C,MessageRouter:()=>p,MonacoEditor:()=>b,OutputPanel:()=>f,PersistenceManager:()=>u,RunButton:()=>y,ServerBlock:()=>g,TinyGoExecutor:()=>x,WasmBlock:()=>k,hasEditableBlocks:()=>S,initializeWasm:()=>N,isMonacoLoaded:()=>A,loadMonaco:()=>E,preloadMonaco:()=>M});var p=class{constructor(e=!1){this.handlers=new Map;this.debug=e}register(e,t){this.handlers.has(e)&&console.warn(`[MessageRouter] Overwriting handler for block: ${e}`),this.handlers.set(e,t),this.debug&&console.log(`[MessageRouter] Registered handler for block: ${e}`)}unregister(e){this.handlers.delete(e),this.debug&&console.log(`[MessageRouter] Unregistered handler for block: ${e}`)}route(e){try{let t=typeof e=="string"?JSON.parse(e):e,{blockID:r,action:o,data:i}=t;if(o==="reload"){this.handleReload(i?.filePath||"");return}if(!r){console.error("[MessageRouter] Message missing blockID:",t);return}let s=this.handlers.get(r);if(!s){console.warn(`[MessageRouter] No handler for block: ${r}`);return}this.debug&&console.log(`[MessageRouter] Routing to ${r}:`,{action:o,data:i}),s(o,i)}catch(t){console.error("[MessageRouter] Error routing message:",t)}}handleReload(e){console.log(`[MessageRouter] Page reloading: ${e} changed`),this.showReloadNotification(e),setTimeout(()=>{window.location.reload()},500)}showReloadNotification(e){let t=document.getElementById("livepage-reload-notification");t&&t.remove();let r=document.createElement("div");r.id="livepage-reload-notification",r.innerHTML=`
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100000;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
      ">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="font-size: 20px;">\u{1F504}</div>
          <div>
            <div style="font-weight: 600;">File Updated</div>
            <div style="opacity: 0.9; font-size: 12px; margin-top: 2px;">${e}</div>
          </div>
        </div>
      </div>
    `;let o=document.createElement("style");o.textContent=`
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `,document.head.appendChild(o),document.body.appendChild(r)}createEnvelope(e,t,r={}){return{blockID:e,action:t,data:r}}getRegisteredBlocks(){return Array.from(this.handlers.keys())}clear(){this.handlers.clear(),this.debug&&console.log("[MessageRouter] Cleared all handlers")}};var u=class{constructor(e="livepage:persistence",t=!0,r=!1){this.storageKey=e,this.enabled=t&&this.isLocalStorageAvailable(),this.debug=r,!this.enabled&&t&&console.warn("[PersistenceManager] localStorage not available, persistence disabled")}isLocalStorageAvailable(){try{let e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}saveCode(e,t){if(this.enabled)try{let r=this.loadAll();r.code[e]=t,r.timestamp=Date.now(),localStorage.setItem(this.storageKey,JSON.stringify(r)),this.debug&&console.log(`[PersistenceManager] Saved code for block: ${e}`)}catch(r){console.error("[PersistenceManager] Error saving code:",r)}}loadCode(e){if(!this.enabled)return null;try{return this.loadAll().code[e]||null}catch(t){return console.error("[PersistenceManager] Error loading code:",t),null}}loadAll(){if(!this.enabled)return{code:{},timestamp:Date.now()};try{let e=localStorage.getItem(this.storageKey);if(!e)return{code:{},timestamp:Date.now()};let t=JSON.parse(e);return!t.code||typeof t.code!="object"?(console.warn("[PersistenceManager] Invalid data structure, resetting"),{code:{},timestamp:Date.now()}):t}catch(e){return console.error("[PersistenceManager] Error loading data:",e),{code:{},timestamp:Date.now()}}}clearCode(e){if(this.enabled)try{let t=this.loadAll();delete t.code[e],t.timestamp=Date.now(),localStorage.setItem(this.storageKey,JSON.stringify(t)),this.debug&&console.log(`[PersistenceManager] Cleared code for block: ${e}`)}catch(t){console.error("[PersistenceManager] Error clearing code:",t)}}clearAll(){if(this.enabled)try{localStorage.removeItem(this.storageKey),this.debug&&console.log("[PersistenceManager] Cleared all persisted data")}catch(e){console.error("[PersistenceManager] Error clearing all data:",e)}}getPersistedBlocks(){if(!this.enabled)return[];let e=this.loadAll();return Object.keys(e.code)}hasPersistedCode(e){if(!this.enabled)return!1;let t=this.loadAll();return e in t.code}getLastUpdate(){return this.enabled?this.loadAll().timestamp:null}};var c=class{constructor(e,t,r=!1){this.element=e.element,this.metadata=e.metadata,this.persistence=t,this.initialCode=e.initialCode||"",this.currentCode=this.initialCode,this.debug=r}get id(){return this.metadata.id}get type(){return this.metadata.type}getCode(){return this.currentCode}setCode(e){this.currentCode=e,this.metadata.editable&&this.persistence.saveCode(this.id,e)}reset(){this.setCode(this.initialCode),this.debug&&console.log(`[Block:${this.id}] Reset to initial code`)}loadPersistedCode(){if(!this.metadata.editable)return this.initialCode;let e=this.persistence.loadCode(this.id);return e?(this.debug&&console.log(`[Block:${this.id}] Loaded persisted code`),e):this.initialCode}createBlockWrapper(){let e=document.createElement("div");return e.className=`livepage-block livepage-block-${this.type}`,e.dataset.blockId=this.id,e.dataset.blockType=this.type,e}log(...e){this.debug&&console.log(`[Block:${this.id}]`,...e)}error(...e){console.error(`[Block:${this.id}]`,...e)}};var g=class extends c{constructor(t,r,o=!1){super(t,r,o);this.codeElement=null}initialize(){this.log("Initializing server block"),this.codeElement=this.element.querySelector("code")||this.element,this.element.classList.add("livepage-server-block"),this.metadata.readonly&&this.element.classList.add("readonly"),this.element.dataset.blockId=this.id,this.element.dataset.language=this.metadata.language,this.render(),this.log("Server block initialized")}destroy(){this.log("Destroying server block")}handleMessage(t,r){this.log("Received message:",t,r),console.warn(`[ServerBlock:${this.id}] Received unexpected message:`,t)}render(){this.codeElement&&this.log("Rendered server block")}};var m=class extends c{constructor(t,r,o=!1){super(t,r,o);this.client=null;this.containerElement=null;this.sendMessage=null}initialize(){this.log("Initializing interactive block"),this.containerElement=this.element.querySelector("[data-interactive-content]")||this.element,this.element.classList.add("livepage-interactive-block"),this.element.dataset.blockId=this.id,this.metadata.stateRef&&(this.element.dataset.stateRef=this.metadata.stateRef),this.attachEventHandlers(),this.log("Interactive block initialized")}destroy(){this.log("Destroying interactive block"),this.client&&(this.client=null)}handleMessage(t,r){switch(this.log("Received message:",t,r),t){case"tree":r.tree&&this.containerElement&&this.updateDOM(r.tree);break;case"update":r.html&&this.containerElement&&(this.containerElement.innerHTML=r.html,this.log("DOM updated with HTML"));break;case"error":this.error("Server error:",r.message);break;default:this.log("Unknown action:",t)}}setMessageSender(t){this.sendMessage=t}updateDOM(t){if(!(!this.client||!this.containerElement))try{t.html&&(this.containerElement.innerHTML=t.html),this.log("DOM updated")}catch(r){this.error("Error updating DOM:",r)}}attachEventHandlers(){this.element&&(this.element.addEventListener("click",t=>this.handleClick(t),!0),this.element.addEventListener("submit",t=>this.handleSubmit(t),!0),this.element.addEventListener("change",t=>this.handleChange(t),!0))}handleClick(t){let o=t.target.getAttribute("lvt-click");o&&(t.preventDefault(),this.sendAction(o,{}),this.log("Click action:",o))}handleSubmit(t){let r=t.target,o=r.getAttribute("lvt-submit");if(o){t.preventDefault();let i=new FormData(r),s={};i.forEach((l,a)=>{s[a]=l}),this.sendAction(o,s),this.log("Submit action:",o,s)}}handleChange(t){let r=t.target,o=r.getAttribute("lvt-change");if(o){let i={value:r.value};this.sendAction(o,i),this.log("Change action:",o,i)}}sendAction(t,r={}){if(!this.sendMessage){this.error("Cannot send action - no message sender configured");return}this.sendMessage(this.id,t,r)}};var _="0.45.0",h=`https://cdn.jsdelivr.net/npm/monaco-editor@${_}/min`,w=null,v=null;function F(){return new Promise((n,e)=>{if(typeof window.require=="function"){n();return}let t=document.createElement("script");t.src=`${h}/vs/loader.js`,t.async=!0,t.onload=()=>n(),t.onerror=()=>e(new Error("Failed to load Monaco loader from CDN")),document.head.appendChild(t)})}function U(){window.MonacoEnvironment={getWorkerUrl:function(n,e){let t=`${h}/vs/base/worker/workerMain.js`;return e==="json"?`${h}/vs/language/json/json.worker.js`:e==="css"||e==="scss"||e==="less"?`${h}/vs/language/css/css.worker.js`:e==="html"||e==="handlebars"||e==="razor"?`${h}/vs/language/html/html.worker.js`:e==="typescript"||e==="javascript"?`${h}/vs/language/typescript/ts.worker.js`:t}}}async function E(){if(w)return w;if(v)return v;console.log("[MonacoLoader] Loading Monaco Editor from CDN...");let n=performance.now();return v=(async()=>{try{await F();let e=window.require;if(!e)throw new Error("AMD loader not available after loading");return e.config({paths:{vs:`${h}/vs`}}),U(),await new Promise((t,r)=>{e(["vs/editor/editor.main"],o=>{if(!o){r(new Error("Monaco module loaded but is undefined"));return}w=o;let i=Math.round(performance.now()-n);console.log(`[MonacoLoader] Monaco Editor loaded from CDN in ${i}ms`),t(o)})})}catch(e){throw v=null,e}})(),v}function A(){return w!==null}function M(){!w&&!v&&E().catch(n=>{console.error("[MonacoLoader] Failed to preload Monaco from CDN:",n)})}function S(){return document.querySelectorAll('[data-block-type="wasm"]').length>0}var b=class{constructor(e,t,r){this.editor=null;this.monaco=null;this.onChangeCallback=null;this.editorDiv=null;this.initPromise=null;this.container=e,this.initialCode=t,this.options=r,this.initPromise=this.initialize()}async initialize(){let e=document.createElement("div");e.className="livepage-monaco-loading",e.style.padding="2rem",e.style.textAlign="center",e.style.color="#999",e.textContent="Loading editor...",this.container.appendChild(e);try{this.monaco=await E(),e.remove(),this.editorDiv=document.createElement("div"),this.editorDiv.className="livepage-monaco-editor",this.editorDiv.style.height="300px",this.editorDiv.style.width="100%",this.container.appendChild(this.editorDiv),this.editor=this.monaco.editor.create(this.editorDiv,{value:this.initialCode,language:this.options.language,theme:this.options.theme||"vs-dark",readOnly:this.options.readonly,minimap:{enabled:this.options.minimap??!0},lineNumbers:this.options.lineNumbers!==!1?"on":"off",scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:14,tabSize:4,insertSpaces:!1}),this.editor.onDidChangeModelContent(()=>{this.onChangeCallback&&this.editor&&this.onChangeCallback(this.editor.getValue())})}catch(t){console.error("[MonacoEditor] Failed to load Monaco:",t),e.textContent="Failed to load editor",e.style.color="#f44"}}async ensureReady(){this.initPromise&&await this.initPromise}getValue(){return this.editor?.getValue()||""}async setValue(e){await this.ensureReady(),this.editor?.setValue(e)}onChange(e){this.onChangeCallback=e}async setReadOnly(e){await this.ensureReady(),this.editor?.updateOptions({readOnly:e})}async focus(){await this.ensureReady(),this.editor?.focus()}async layout(){await this.ensureReady(),this.editor?.layout()}destroy(){this.editor?.dispose(),this.editor=null}async getEditor(){return await this.ensureReady(),this.editor}};var f=class{constructor(e,t=1e3,r=!0){this.lines=[];this.maxLines=t,this.autoScroll=r,this.element=this.createPanel(),e.appendChild(this.element)}createPanel(){let e=document.createElement("div");e.className="livepage-output-panel",e.innerHTML=`
      <div class="output-header">
        <span class="output-title">Output</span>
        <button class="output-clear" title="Clear output">Clear</button>
      </div>
      <div class="output-content"></div>
    `;let t=e.querySelector(".output-clear");return t&&t.addEventListener("click",()=>this.clear()),e}append(e,t){let r={type:e,text:t,timestamp:Date.now()};this.lines.push(r),this.lines.length>this.maxLines&&(this.lines=this.lines.slice(-this.maxLines)),this.render()}stdout(e){this.append("stdout",e)}stderr(e){this.append("stderr",e)}error(e){this.append("error",e)}info(e){this.append("info",e)}clear(){this.lines=[],this.render()}show(){this.element.style.display="block"}hide(){this.element.style.display="none"}render(){let e=this.element.querySelector(".output-content");if(e){e.innerHTML="";for(let t of this.lines){let r=document.createElement("div");r.className=`output-line output-${t.type}`,r.textContent=t.text,e.appendChild(r)}this.autoScroll&&(e.scrollTop=e.scrollHeight)}}getElement(){return this.element}destroy(){this.element.remove()}};var y=class{constructor(e,t="Run"){this.callback=null;this.isRunning=!1;this.element=this.createButton(t),e.appendChild(this.element)}createButton(e){let t=document.createElement("button");return t.className="livepage-run-button",t.textContent=e,t.addEventListener("click",()=>this.handleClick()),t}onClick(e){this.callback=e}async handleClick(){if(!(this.isRunning||!this.callback)){this.setRunning(!0);try{await this.callback()}catch(e){console.error("[RunButton] Error executing callback:",e)}finally{this.setRunning(!1)}}}setRunning(e){this.isRunning=e,this.element.disabled=e,e?(this.element.classList.add("running"),this.element.textContent="Running..."):(this.element.classList.remove("running"),this.element.textContent="Run")}enable(){this.element.disabled=!1}disable(){this.element.disabled=!0}getElement(){return this.element}destroy(){this.element.remove()}};var x=class{constructor(e="/api/compile",t=!1){this.serverUrl=e,this.debug=t}async execute(e){this.debug&&console.log("[TinyGoExecutor] Executing code:",e);try{let t=await fetch(this.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e})});if(!t.ok){let o=await t.text();return{stdout:"",stderr:o,error:`Compilation failed: ${o}`,exitCode:1}}let r=await t.arrayBuffer();return await this.executeWasm(r)}catch(t){return{stdout:"",stderr:"",error:`Execution failed: ${t instanceof Error?t.message:String(t)}`,exitCode:1}}}async executeWasm(e){let t="",r="";try{let o=new window.Go,i=console.log,s=console.error;console.log=(...a)=>{t+=a.join(" ")+`
`},console.error=(...a)=>{r+=a.join(" ")+`
`};let l=await WebAssembly.instantiate(e,o.importObject);return await o.run(l.instance),console.log=i,console.error=s,{stdout:t,stderr:r,exitCode:0}}catch(o){let i=o instanceof Error?o.message:String(o);return{stdout:t,stderr:r,error:`WASM execution failed: ${i}`,exitCode:1}}}static isSupported(){return typeof WebAssembly<"u"&&typeof window.Go<"u"}};async function N(){if(!window.Go)try{let n=document.createElement("script");n.src="/assets/wasm_exec.js",await new Promise((e,t)=>{n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load wasm_exec.js")),document.head.appendChild(n)}),console.log("[TinyGoExecutor] WASM environment initialized")}catch(n){throw console.error("[TinyGoExecutor] Failed to initialize WASM:",n),n}}var k=class extends c{constructor(t,r,o=!1){super(t,r,o);this.editor=null;this.outputPanel=null;this.runButton=null;this.executor=null;this.containerElement=null;this.editorContainer=null;this.controlsContainer=null}initialize(){this.log("Initializing WASM block"),this.currentCode=this.loadPersistedCode(),this.createBlockStructure(),this.initializeEditor(),this.initializeControls(),this.initializeExecutor(),this.log("WASM block initialized")}destroy(){this.log("Destroying WASM block"),this.editor?.destroy(),this.outputPanel?.destroy(),this.runButton?.destroy(),this.editor=null,this.outputPanel=null,this.runButton=null,this.executor=null}handleMessage(t,r){this.log("Received message:",t,r)}createBlockStructure(){this.containerElement=document.createElement("div"),this.containerElement.className="livepage-wasm-block",this.containerElement.dataset.blockId=this.id,this.editorContainer=document.createElement("div"),this.editorContainer.className="wasm-editor-container",this.containerElement.appendChild(this.editorContainer),this.controlsContainer=document.createElement("div"),this.controlsContainer.className="wasm-controls",this.containerElement.appendChild(this.controlsContainer),this.element.parentNode&&this.element.parentNode.replaceChild(this.containerElement,this.element)}initializeEditor(){this.editorContainer&&(this.editor=new b(this.editorContainer,this.currentCode,{language:this.metadata.language||"go",readonly:this.metadata.readonly||!1,theme:"vs-dark",minimap:!1,lineNumbers:!0}),this.editor.onChange(t=>{this.setCode(t)}),this.log("Editor initialized"))}initializeControls(){if(!this.controlsContainer)return;let t=document.createElement("div");t.className="wasm-buttons",this.runButton=new y(t,"Run"),this.runButton.onClick(()=>this.executeCode());let r=document.createElement("button");r.className="livepage-reset-button",r.textContent="Reset",r.addEventListener("click",()=>this.resetCode()),t.appendChild(r),this.controlsContainer.appendChild(t),this.outputPanel=new f(this.controlsContainer),this.outputPanel.hide(),this.log("Controls initialized")}initializeExecutor(){this.executor=new x("/api/compile",this.debug),this.log("Executor initialized")}async executeCode(){if(!this.editor||!this.executor||!this.outputPanel){this.error("Cannot execute - components not initialized");return}let t=this.editor.getValue();this.log("Executing code"),this.outputPanel.clear(),this.outputPanel.show(),this.outputPanel.info("Compiling and running...");try{let r=await this.executor.execute(t);this.outputPanel.clear(),r.stdout&&this.outputPanel.stdout(r.stdout),r.stderr&&this.outputPanel.stderr(r.stderr),r.error&&this.outputPanel.error(r.error),r.exitCode===0&&!r.stdout&&!r.stderr&&this.outputPanel.info("Program completed successfully (no output)"),this.log("Execution completed with exit code:",r.exitCode)}catch(r){let o=r instanceof Error?r.message:String(r);this.outputPanel.error(`Execution error: ${o}`),this.error("Execution error:",r)}}resetCode(){this.editor&&(this.editor.setValue(this.initialCode),this.setCode(this.initialCode),this.outputPanel?.clear(),this.log("Code reset to initial state"))}};var C=class{constructor(e){this.blocks=new Map;this.ws=null;this.reconnectTimer=null;this.isConnected=!1;this.options={debug:!1,persistence:!0,cdnFallback:!1,...e},this.router=new p(this.options.debug),this.persistence=new u("livepage:persistence",this.options.persistence,this.options.debug),this.options.debug&&console.log("[LivepageClient] Initialized with options:",this.options)}connect(){if(this.ws){console.warn("[LivepageClient] Already connected");return}try{this.ws=new WebSocket(this.options.wsUrl),this.ws.onopen=()=>{this.isConnected=!0,console.log("[LivepageClient] Connected to server"),this.options.onConnect?.()},this.ws.onclose=()=>{this.isConnected=!1,console.log("[LivepageClient] Disconnected from server"),this.options.onDisconnect?.(),this.scheduleReconnect()},this.ws.onerror=e=>{console.error("[LivepageClient] WebSocket error:",e),this.options.onError?.(new Error("WebSocket error"))},this.ws.onmessage=e=>{this.handleMessage(e.data)}}catch(e){console.error("[LivepageClient] Failed to connect:",e),this.options.onError?.(e)}}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1}handleMessage(e){this.options.debug&&console.log("[LivepageClient] Received message:",e),this.router.route(e)}send(e,t,r={}){if(!this.isConnected||!this.ws){console.warn("[LivepageClient] Cannot send - not connected");return}let i=JSON.stringify({blockID:e,action:t,data:r});this.options.debug&&console.log("[LivepageClient] Sending message:",i),this.ws.send(i)}scheduleReconnect(){this.reconnectTimer||(this.reconnectTimer=window.setTimeout(()=>{this.reconnectTimer=null,console.log("[LivepageClient] Attempting to reconnect..."),this.connect()},3e3))}discoverBlocks(){console.log("[LivepageClient] Discovering blocks...");let e=document.querySelectorAll("[data-livepage-block]");for(let t of Array.from(e))try{let r=this.extractMetadata(t),o=this.extractCode(t),i={element:t,metadata:r,initialCode:o};this.registerBlock(i)}catch(r){console.error("[LivepageClient] Error discovering block:",r)}console.log(`[LivepageClient] Discovered ${this.blocks.size} blocks`)}extractMetadata(e){let t=e.dataset.blockId||this.generateBlockId(),r=e.dataset.blockType||"server",o=e.dataset.language||"go",i=e.dataset.readonly==="true",s=e.dataset.editable==="true",l=e.dataset.stateRef;return{id:t,type:r,language:o,readonly:i,editable:s,stateRef:l}}extractCode(e){let t=e.querySelector("code");return t?t.textContent||"":e.textContent||""}generateBlockId(){return`block-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}registerBlock(e){let{metadata:t}=e;if(this.blocks.has(t.id)){console.warn(`[LivepageClient] Block already registered: ${t.id}`);return}let r;switch(t.type){case"server":r=new g(e,this.persistence,this.options.debug);break;case"interactive":case"lvt":r=new m(e,this.persistence,this.options.debug),r.setMessageSender((o,i,s)=>{this.send(o,i,s)});break;case"wasm":r=new k(e,this.persistence,this.options.debug);break;default:console.warn(`[LivepageClient] Unknown block type: ${t.type}`);return}r.initialize(),this.router.register(t.id,(o,i)=>{r.handleMessage(o,i)}),this.blocks.set(t.id,r),this.options.debug&&console.log(`[LivepageClient] Registered block: ${t.id} (${t.type})`)}unregisterBlock(e){let t=this.blocks.get(e);t&&(t.destroy(),this.router.unregister(e),this.blocks.delete(e),this.options.debug&&console.log(`[LivepageClient] Unregistered block: ${e}`))}getBlock(e){return this.blocks.get(e)}getBlockIds(){return Array.from(this.blocks.keys())}destroy(){console.log("[LivepageClient] Destroying client");for(let e of this.blocks.values())e.destroy();this.blocks.clear(),this.router.clear(),this.disconnect()}};var L=class{constructor(){this.steps=[];this.currentStepIndex=0;this.sidebar=null;this.bottomNav=null;this.init()}init(){document.querySelector(".livepage-nav-sidebar")||(this.parseSteps(),this.steps.length!==0&&(this.createSidebar(),this.createBottomNav(),this.setupKeyboardShortcuts(),this.setupHashNavigation(),this.setupScrollTracking(),this.initializeFromHash()))}parseSteps(){document.querySelectorAll("h2").forEach((t,r)=>{let o=t.id||this.generateId(t.textContent||"");t.id||(t.id=o),this.steps.push({id:o,title:t.textContent||"",element:t,index:r})})}generateId(e){return e.toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}createSidebar(){this.sidebar=document.createElement("nav"),this.sidebar.className="livepage-nav-sidebar",this.sidebar.innerHTML=`
      <div class="nav-sidebar-header">
        <h3>Contents</h3>
      </div>
      <ol class="nav-sidebar-steps">
        ${this.steps.map((e,t)=>`
          <li class="nav-step ${t===0?"active":""}" data-step="${t}">
            <a href="#${e.id}">
              <span class="step-number">${t+1}</span>
              <span class="step-title">${e.title}</span>
            </a>
          </li>
        `).join("")}
      </ol>
    `,this.sidebar.querySelectorAll(".nav-step").forEach((e,t)=>{e.addEventListener("click",r=>{r.preventDefault(),this.navigateToStep(t)})}),document.body.appendChild(this.sidebar)}createBottomNav(){this.bottomNav=document.createElement("nav"),this.bottomNav.className="livepage-nav-bottom",this.bottomNav.innerHTML=`
      <button class="nav-btn nav-prev" ${this.currentStepIndex===0?"disabled":""}>
        <span class="nav-arrow">\u2190</span>
        <span class="nav-label">Previous</span>
      </button>
      <span class="nav-progress">
        Step <span class="current-step">1</span> of <span class="total-steps">${this.steps.length}</span>
      </span>
      <button class="nav-btn nav-next" ${this.currentStepIndex===this.steps.length-1?"disabled":""}>
        <span class="nav-label">Next</span>
        <span class="nav-arrow">\u2192</span>
      </button>
    `;let e=this.bottomNav.querySelector(".nav-prev"),t=this.bottomNav.querySelector(".nav-next");e?.addEventListener("click",()=>this.navigatePrev()),t?.addEventListener("click",()=>this.navigateNext()),document.body.appendChild(this.bottomNav)}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement))switch(e.key){case"ArrowRight":case"ArrowDown":e.preventDefault(),this.navigateNext();break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),this.navigatePrev();break}})}setupHashNavigation(){window.addEventListener("hashchange",()=>{this.handleHashChange()})}setupScrollTracking(){let e=new IntersectionObserver(t=>{t.forEach(r=>{if(r.isIntersecting){let o=r.target,i=this.steps.findIndex(s=>s.element===o);i!==-1&&i!==this.currentStepIndex&&this.updateCurrentStep(i,!1)}})},{threshold:.5,rootMargin:"-100px 0px -50% 0px"});this.steps.forEach(t=>e.observe(t.element))}initializeFromHash(){let e=window.location.hash.slice(1);if(e){let t=this.steps.findIndex(r=>r.id===e);if(t!==-1){this.navigateToStep(t);return}}this.updateCurrentStep(0,!1)}handleHashChange(){let e=window.location.hash.slice(1);if(e){let t=this.steps.findIndex(r=>r.id===e);t!==-1&&this.navigateToStep(t,!1)}}navigateToStep(e,t=!0){e<0||e>=this.steps.length||(this.updateCurrentStep(e,!0),t&&history.pushState(null,"",`#${this.steps[e].id}`))}navigateNext(){this.currentStepIndex<this.steps.length-1&&this.navigateToStep(this.currentStepIndex+1)}navigatePrev(){this.currentStepIndex>0&&this.navigateToStep(this.currentStepIndex-1)}updateCurrentStep(e,t=!0){if(this.currentStepIndex=e,this.sidebar&&this.sidebar.querySelectorAll(".nav-step").forEach((r,o)=>{r.classList.toggle("active",o===e)}),this.bottomNav){let r=this.bottomNav.querySelector(".nav-prev"),o=this.bottomNav.querySelector(".nav-next"),i=this.bottomNav.querySelector(".current-step");r&&(r.disabled=e===0),o&&(o.disabled=e===this.steps.length-1),i&&(i.textContent=String(e+1))}t&&this.scrollToStep(e)}scrollToStep(e){let t=this.steps[e];t&&t.element.scrollIntoView({behavior:"smooth",block:"start"})}getCurrentStep(){return this.currentStepIndex}getTotalSteps(){return this.steps.length}goToStep(e){this.navigateToStep(e)}};var T=class{constructor(){this.searchIndex=[];this.searchModal=null;this.searchInput=null;this.resultsContainer=null;this.selectedIndex=0;document.querySelector(".livepage-nav-sidebar")&&this.init()}async init(){await this.loadSearchIndex(),this.createSearchModal(),this.setupKeyboardShortcuts(),this.addSearchButton()}async loadSearchIndex(){try{let e=await fetch("/search-index.json");if(!e.ok){console.warn("[Search] Failed to load search index");return}this.searchIndex=await e.json(),console.log(`[Search] Loaded ${this.searchIndex.length} pages`)}catch(e){console.error("[Search] Error loading search index:",e)}}createSearchModal(){this.searchModal=document.createElement("div"),this.searchModal.className="search-modal",this.searchModal.innerHTML=`
      <div class="search-backdrop"></div>
      <div class="search-container">
        <div class="search-input-wrapper">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            class="search-input"
            placeholder="Search documentation..."
            autocomplete="off"
            spellcheck="false"
          />
          <button class="search-close" aria-label="Close search">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="search-results"></div>
        <div class="search-footer">
          <div class="search-hints">
            <span><kbd>\u2191</kbd><kbd>\u2193</kbd> Navigate</span>
            <span><kbd>\u21B5</kbd> Select</span>
            <span><kbd>Esc</kbd> Close</span>
          </div>
        </div>
      </div>
    `,document.body.appendChild(this.searchModal),this.searchInput=this.searchModal.querySelector(".search-input"),this.resultsContainer=this.searchModal.querySelector(".search-results"),this.searchInput?.addEventListener("input",()=>this.handleSearch()),this.searchInput?.addEventListener("keydown",e=>this.handleKeyDown(e)),this.searchModal.querySelector(".search-close")?.addEventListener("click",()=>this.closeSearch()),this.searchModal.querySelector(".search-backdrop")?.addEventListener("click",()=>this.closeSearch())}addSearchButton(){let e=document.querySelector(".livepage-nav-sidebar");if(!e)return;let t=e.querySelector(".nav-header");if(!t)return;let r=document.createElement("button");r.className="search-button",r.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <span>Search</span>
      <kbd>\u2318K</kbd>
    `,r.addEventListener("click",()=>this.openSearch()),t.appendChild(r)}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key==="k"&&(e.preventDefault(),this.openSearch()),e.key==="Escape"&&this.searchModal?.classList.contains("open")&&this.closeSearch()})}openSearch(){this.searchModal?.classList.add("open"),this.searchInput?.focus(),this.selectedIndex=0}closeSearch(){this.searchModal?.classList.remove("open"),this.searchInput&&(this.searchInput.value=""),this.resultsContainer&&(this.resultsContainer.innerHTML="")}handleSearch(){let e=this.searchInput?.value.trim()||"";if(e.length===0){this.resultsContainer&&(this.resultsContainer.innerHTML="");return}let t=this.search(e);this.renderResults(t)}search(e){let t=e.toLowerCase(),r=[];for(let o of this.searchIndex){let i=o.title.toLowerCase(),s=o.content.toLowerCase(),l=i.includes(t),a=s.includes(t);if(l||a){let d=0;l&&(d+=10,i===t?d+=50:i.startsWith(t)&&(d+=20)),a&&(d+=1),r.push({...o,score:d,titleMatches:l,contentMatches:a})}}return r.sort((o,i)=>i.score-o.score),r.slice(0,10)}renderResults(e){if(this.resultsContainer){if(e.length===0){this.resultsContainer.innerHTML='<div class="search-no-results">No results found</div>';return}this.resultsContainer.innerHTML=e.map((t,r)=>`
      <a
        href="${t.path}"
        class="search-result ${r===this.selectedIndex?"selected":""}"
        data-index="${r}"
      >
        <div class="search-result-title">
          ${this.highlightMatch(t.title,this.searchInput?.value||"")}
        </div>
        ${t.section?`<div class="search-result-section">${t.section}</div>`:""}
        <div class="search-result-content">
          ${this.highlightMatch(this.truncateContent(t.content),this.searchInput?.value||"")}
        </div>
      </a>
    `).join(""),this.resultsContainer.querySelectorAll(".search-result").forEach(t=>{t.addEventListener("click",()=>this.closeSearch())})}}highlightMatch(e,t){if(!t)return e;let r=new RegExp(`(${this.escapeRegex(t)})`,"gi");return e.replace(r,"<mark>$1</mark>")}truncateContent(e,t=200){return e.length<=t?e:e.substring(0,t)+"..."}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}handleKeyDown(e){if(!this.resultsContainer)return;let t=this.resultsContainer.querySelectorAll(".search-result");switch(e.key){case"Escape":e.preventDefault(),this.closeSearch();break;case"ArrowDown":if(t.length===0)return;e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,t.length-1),this.updateSelection();break;case"ArrowUp":if(t.length===0)return;e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.updateSelection();break;case"Enter":if(t.length===0)return;e.preventDefault();let r=t[this.selectedIndex];r&&(window.location.href=r.href,this.closeSearch());break}}updateSelection(){if(!this.resultsContainer)return;let e=this.resultsContainer.querySelectorAll(".search-result");e.forEach((r,o)=>{r.classList.toggle("selected",o===this.selectedIndex)});let t=e[this.selectedIndex];t&&t.scrollIntoView({block:"nearest",behavior:"smooth"})}};var B=class n{static{this.COPY_BUTTON_CLASS="code-copy-btn"}static{this.CODE_WRAPPER_CLASS="code-block-wrapper"}static{this.COPIED_CLASS="copied"}constructor(){this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.addCopyButtons()):this.addCopyButtons()}addCopyButtons(){document.querySelectorAll("pre > code").forEach(t=>{let r=t.parentElement;if(!r||r.querySelector(`.${n.COPY_BUTTON_CLASS}`))return;if(!r.parentElement?.classList.contains(n.CODE_WRAPPER_CLASS)){let i=document.createElement("div");i.className=n.CODE_WRAPPER_CLASS,r.parentNode?.insertBefore(i,r),i.appendChild(r)}let o=this.createCopyButton();r.appendChild(o),o.addEventListener("click",i=>{i.preventDefault(),this.copyCode(t,o)})})}createCopyButton(){let e=document.createElement("button");return e.className=n.COPY_BUTTON_CLASS,e.setAttribute("aria-label","Copy code to clipboard"),e.innerHTML=this.getCopyIcon(),e}async copyCode(e,t){let r=e.textContent||"";try{await navigator.clipboard.writeText(r),this.showCopiedFeedback(t)}catch(o){console.error("Failed to copy code:",o),this.fallbackCopy(r,t)}}showCopiedFeedback(e){e.classList.add(n.COPIED_CLASS),e.innerHTML=this.getCheckIcon(),e.setAttribute("aria-label","Code copied!"),setTimeout(()=>{e.classList.remove(n.COPIED_CLASS),e.innerHTML=this.getCopyIcon(),e.setAttribute("aria-label","Copy code to clipboard")},2e3)}fallbackCopy(e,t){let r=document.createElement("textarea");r.value=e,r.style.position="fixed",r.style.opacity="0",document.body.appendChild(r),r.select();try{document.execCommand("copy"),this.showCopiedFeedback(t)}catch(o){console.error("Fallback copy failed:",o)}finally{document.body.removeChild(r)}}getCopyIcon(){return`
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10.5 2H3.5C2.67 2 2 2.67 2 3.5V10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        <rect x="5.5" y="5.5" width="8" height="8" rx="1" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    `}getCheckIcon(){return`
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 8L6.5 11.5L13 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `}};var I=class{constructor(){this.sections=[];this.tocElement=null;this.currentActiveSection=-1;this.init()}init(){document.querySelector(".livepage-nav-sidebar")&&(this.parseSections(),this.sections.length!==0&&(this.createTOC(),this.setupScrollTracking()))}parseSections(){document.querySelectorAll(".content-wrapper h2").forEach((t,r)=>{let o=t.id||this.generateId(t.textContent||"");t.id||(t.id=o),this.sections.push({id:o,title:t.textContent||"",element:t,index:r})})}generateId(e){return e.toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}createTOC(){let e=document.querySelector(".livepage-nav-sidebar");if(!e)return;let t=e.querySelector(".nav-page-link.active");if(!t)return;let r=t.closest("li");if(!r)return;let o=document.createElement("ul");o.className="page-toc-list",o.innerHTML=this.sections.map((i,s)=>`
      <li class="page-toc-item" data-section="${s}">
        <a href="#${i.id}" class="page-toc-link">
          ${this.escapeHtml(i.title)}
        </a>
      </li>
    `).join(""),o.querySelectorAll(".page-toc-item").forEach((i,s)=>{i.querySelector("a")?.addEventListener("click",a=>{a.preventDefault(),this.scrollToSection(s)})}),r.appendChild(o),r.classList.add("has-subnav"),this.tocElement=o}escapeHtml(e){let t=document.createElement("div");return t.textContent=e,t.innerHTML}setupScrollTracking(){let e=new IntersectionObserver(t=>{t.forEach(r=>{if(r.isIntersecting){let o=r.target,i=this.sections.findIndex(s=>s.element===o);i!==-1&&i!==this.currentActiveSection&&this.updateActiveSection(i)}})},{threshold:.5,rootMargin:"-100px 0px -50% 0px"});this.sections.forEach(t=>e.observe(t.element))}updateActiveSection(e){this.currentActiveSection=e,this.tocElement&&this.tocElement.querySelectorAll(".page-toc-item").forEach((t,r)=>{t.classList.toggle("active",r===e)})}scrollToSection(e){let t=this.sections[e];t&&(t.element.scrollIntoView({behavior:"smooth",block:"start"}),history.pushState(null,"",`#${t.id}`))}};function D(){if(window.LIVEPAGE_DISABLE_AUTO_INIT){console.log("[Livepage] Auto-initialization disabled");return}let e=document.querySelector('meta[name="livepage-ws-url"]')?.content||`ws://${window.location.host}/ws`,r=document.querySelector('meta[name="livepage-debug"]')?.content==="true";S()&&(console.log("[Livepage] Preloading Monaco Editor for WASM blocks..."),M());let o=new C({wsUrl:e,debug:r,persistence:!0,onConnect:()=>console.log("[Livepage] Connected"),onDisconnect:()=>console.log("[Livepage] Disconnected"),onError:P=>console.error("[Livepage] Error:",P)});o.discoverBlocks(),o.getBlockIds().some(P=>{let H=o.getBlock(P);return H?.type==="interactive"||H?.type==="lvt"})&&o.connect(),window.livepageClient=o;let s=new L;window.livepageNavigation=s;let l=new I;window.livepagePageTOC=l;let a=new T;window.livepageSearch=a;let d=new B;window.livepageCodeCopy=d,console.log(`[Livepage] Initialized with ${o.getBlockIds().length} blocks`)}typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",D):D());return W(K);})();
//# sourceMappingURL=livepage-client.browser.js.map
